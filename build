#!/bin/bash

devmode=0
while getopts "d" OPT; do
    case "$OPT" in
    d) devmode=1 ;;
    esac
done

[ "$devmode" = 1 ] && {
    esbuildOpts=--sourcemap
}

#create config.ts from ini {{{
AIO_CONFIGTS=./www/config.ts

handle_configts_from_ini() {
    section=""
    while read -r line; do
        case "$line" in
        \[*\])
            name="${line#'['}"
            name="${name%']'}"
            section="$name"
            ;;
        '') continue ;;
        *)
            name="${line%%[[:space:]]=*}"
            value="${line#*=[[:space:]]}"
            case "$section" in
            aio_limas)
                case "$name" in
                    host) host="$value" ;;
                    api) api="$value" ;;
                esac
                ;;
            ui) export "$name"="$value" ;;
            esac
            ;;
        esac
    done <./server-config.ini

    cat <<-EOF >"$AIO_CONFIGTS"
//making this not a constant so that a tampermonkey script can change it because i want to change it with a tampermonkey script
let AIO = "${host:-http://localhost:8080}"
const API = "${api:-/api/v1}"

const ENABLE_UNSAFE = ${enable_unsafe}
EOF
}

handle_configts_from_ini

#}}}

# Generate JS API documentation
generate_js_api_docs() {
    local js_api_file="./www/ui/js_api.ts"
    local docs_file="./www/usage/js_api_docs.html"

    # Create temporary file for processing
    local temp_file=$(mktemp)

    # Extract function documentation using awk
    for file in www/**/*.ts; do
        awk -f ./gen-docs -v "file=${file##www/}" "$file"
    done | sed -e "/{{CONTENT}}/r /dev/stdin" -e "/{{CONTENT}}/d" "./build-system/js_api_docs_template.html" >"$temp_file"

    # Move the processed file to the final location
    mv "$temp_file" "$docs_file"
}

generate_js_api_docs

generateSidebarStyles() {
    styles=$(cat "./www/css/colors.css" "./www/css/general.css" "./www/ui/templates/sidebar-entry.css")
    python -c "
( (f := open('./www/ui/components.js', 'r+')),
   text := f.read(),
   text := text.replace(\"{{{_BUILDTIME_REPLACE_}}}\${Math.random()}\", \"\"\"${styles}\"\"\"),
   f.seek(0),
   f.write(text),
   f.close()
)"
}

#esbuild/typescript stuff
esbuild $(find . -regex '.*\.ts$') --minify --outdir=www $esbuildOpts

generateSidebarStyles

#compile html into one BIG html to avoid having to have all of this in one massive file while working on it. It gets really annoying lol
idx="./www/ui/index.html"
#copy the initial template file to the final output
cp "./www/ui/index-template.html" "$idx"
#for each template
for file in ./www/ui/html-templates/*.html; do
    name="${file##*/}"
    name="${name%.html}"
    #create a template html tag and put it into the final output html file
    cat <<EOTEMPLATE >>"$idx"
<template id="${name}">
$(cat "$file")
</template>

EOTEMPLATE
done

#main go program
${GO:-go} build .
