const calcItems=document.getElementById("calc-items"),expressionInput=document.getElementById("calc-expression"),modeCalc={add(e,t=!0){t&&changeResultStatsWithItem(e),renderCalcItem(e)},sub(e,t=!0){t&&changeResultStatsWithItem(e,-1),removecCalcItem(e)},addList(e,t=!0){t&&changeResultStatsWithItemList(e,1);for(let l of e)renderCalcItem(l)},subList(e,t=!0){t&&changeResultStatsWithItemList(e,-1);for(let l of e)removecCalcItem(l)},*_getValidEntries(){const e=Object.groupBy(globalsNewUi.selectedEntries,l=>String(l.ItemId));let t=calcItems.querySelectorAll("[data-item-id]");for(let l of t){let n=Number(l.getAttribute("data-expression-output")),a=l.getAttribute("data-item-id");!a||n<=0||!e[a]||(yield e[a][0])}},putSelectedInCollection(){const e=prompt("Id of collection");if(!e)return;let t=[];for(let l of this._getValidEntries())t.push(setParent(l.ItemId,BigInt(e)));Promise.all(t).then(l=>{for(let n of l)console.log(n.status)})},addTagsToSelected(){const e=prompt("tags (, seperated)");if(!e)return;const t=e.split(",");for(let l of this._getValidEntries())addEntryTags(l.ItemId,t)}};expressionInput.onchange=function(){for(let e of globalsNewUi.selectedEntries){let t=updateExpressionOutput(e);calcItems.querySelector(`[data-item-id="${e.ItemId}"]`)?.setAttribute("data-expression-output",t.jsStr())}};function updateExpressionOutput(e){let t=expressionInput.value,l=findMetadataById(e.ItemId),n=findUserEntryById(e.ItemId),a={...e,...l,...n},s=makeSymbolsTableFromObj(a),r=new Str(`${l?.Description||""}<br>${l?.Rating||0}`);return t&&(r=parseExpression(t,s)),r}function removecCalcItem(e){calcItems.querySelector(`[data-item-id="${e.ItemId}"]`)?.remove()}function renderCalcItem(e,t=calcItems){let l=document.createElement("calc-entry"),n=l.shadowRoot;if(!n)return;let a=findMetadataById(e.ItemId),s=updateExpressionOutput(e),r=n.getElementById("name");r.innerText=e.En_Title;let i=n.getElementById("calc-thumbnail");a?.Thumbnail&&(i.src=a?.Thumbnail),t.append(l),l.setAttribute("data-expression-output",String(s.jsStr())),l.setAttribute("data-item-id",String(e.ItemId))}function sortCalcDisplay(){let e=[...calcItems.querySelectorAll("[data-item-id]")];e.sort((t,l)=>{let n=t.getAttribute("data-expression-output"),a=l.getAttribute("data-expression-output");return Number(a)-Number(n)}),calcItems.innerHTML="";for(let t of e)calcItems.append(t)}
