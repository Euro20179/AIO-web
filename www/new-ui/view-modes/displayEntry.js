let displayQueue=[];function handleRichText(e){const t={b:()=>["bold",[]],i:()=>["italic",[]],h:()=>["hiliteColor",[prompt("highlight color (yellow)")||"yellow"]],f:()=>["foreColor",[prompt("Foreground color (black)")||"black"]],t:()=>["fontName",[prompt("Font name (sans-serif)")||"sans-serif"]],T:()=>["fontSize",[prompt("Font size (12pt)")||"12pt"]],I:()=>["insertImage",[prompt("Image url (/favicon.ico)")||"/favicon.ico"]],e:()=>[["enableObjectResizing",[]],["enableAbsolutePositionEditor",[]],["enableInlineTableEditing",[]]],s:()=>["strikeThrough",[]],u:()=>["underline",[]],m:()=>["insertHTML",[getSelection()?.toString()||prompt("html (html)")||"html"]],f12:()=>["removeFormat",[]]};if(!e.ctrlKey)return;let n=e.key;if(n in t){let r=t[n]();if(typeof r[0]=="string"){let[i,a]=r;document.execCommand(i,!1,...a)}else for(let[i,a]of r)document.execCommand(i,!1,...a);e.preventDefault()}}async function itemIdentification(e){e.parentElement?.hidePopover();let t=new FormData(e),n=t.get("provider"),r=t.get("query-type"),i=t.get("search"),a=e.getRootNode(),o=a.host.getAttribute("data-item-id");if(!o){alert("Could not get item id");return}let l="";switch(r){case"by-title":let s=a.getElementById("identify-items");l=await titleIdentification(n,i,s);break;case"by-id":l=i;break}finalizeIdentify(l,n,BigInt(o)).then(loadMetadata).then(()=>{let s=globalsNewUi.entries[o];updateInfo({entries:{[String(o)]:s}})})}async function titleIdentification(e,t,n){let i=await(await identify(t,e)).text(),[a,o]=i.split(""),l;try{l=o.split(`
`).filter(Boolean).map(s=>JSON.parse(s))}catch{return console.error("Could not parse json",o.split(`
`)),""}for(;n.children.length;)n.firstChild?.remove();return n.showPopover(),await new Promise(s=>{for(let c of l){console.log(c);let g=document.createElement("figure"),p=document.createElement("img");p.src=c.Thumbnail,p.style.cursor="pointer",p.width=100,p.addEventListener("click",E=>{n.hidePopover(),s(c.ItemId)});let T=document.createElement("h3");T.innerText=c.Title||c.Native_Title,T.title=c.Native_Title||c.Title,g.append(T),g.append(p),n.append(g)}})}function saveItemChanges(e,t){if(!confirm("Are you sure you want to save changes?"))return;const n=e.getElementById("main-title");n&&(t.En_Title=n.innerText);let r=findUserEntryById(t.ItemId);if(!r)return;const i=e.getElementById("style-editor");setUserExtra(r,"styles",i.value);let a=e?.getElementById("notes")?.innerHTML;a==="<br>"&&(a=""),r.Notes=a||"";let o=e.getElementById("info-raw"),l=e.getElementById("meta-info-raw");if(!o||!l)return;const s=(u,f)=>{for(let w of u?.querySelectorAll("tr")||[]){let N=w.firstElementChild,M=w.firstElementChild?.nextElementSibling,b=N.innerText.trim(),$=M.innerText.trim();if(b in f){if(b==="ItemId"){console.log("Skipping ItemId");continue}}else{console.log(`${b} NOT IN ITEM`);continue}let B=f[b]?.constructor;B&&(f[b]=B($))}};s(o,t);let c=findMetadataById(t.ItemId);if(!c)return;s(l,c);const g=mkIntItemId(JSON.stringify(t,(u,f)=>typeof f=="bigint"?String(f):f)),p=mkIntItemId(JSON.stringify(c,(u,f)=>typeof f=="bigint"?String(f):f)),T=mkIntItemId(JSON.stringify(r,(u,f)=>typeof f=="bigint"?String(f):f));let E=[],v=fetch(`${apiPath}/engagement/set-entry`,{body:T,method:"POST"}).then(u=>u.text()).then(console.log).catch(console.error);E.push(v);let m=fetch(`${apiPath}/set-entry`,{body:g,method:"POST"}).then(u=>u.text()).then(console.log).catch(console.error);E.push(m);let y=fetch(`${apiPath}/metadata/set-entry`,{body:p,method:"POST"}).then(u=>u.text()).then(console.log).catch(console.error);E.push(y),updateInfo({entries:{[String(t.ItemId)]:t},userEntries:{[String(t.ItemId)]:r},metadataEntries:{[String(t.ItemId)]:c}})}function changeDisplayItemData(e,t,n,r,i){const a=new CustomEvent("data-changed",{detail:{item:e,user:t,meta:n,events:r}});i.dispatchEvent(a),i.setAttribute("data-item-id",String(e.ItemId))}function mkGenericTbl(e,t){let n=`
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
            `;for(let r in t)n+=`<tr><td>${r}</td><td contenteditable>${t[r]}</td></tr>`;n+="</tbody>",e.innerHTML=n}const displayEntryIntersected=new Set;function onIntersection(e){for(let t of e){const n=t.target.getAttribute("data-item-id")||"NA";if(t.isIntersecting&&displayQueue.length&&!displayEntryIntersected.has(n)){displayEntryIntersected.add(n);let r=displayQueue.shift();if(!r)continue;modeDisplayEntry.add(r,!1)}}}function newEvent(e){const t=new FormData(e),n=t.get("name");if(n==null){alert("Name required");return}const r=t.get("timestamp"),i=t.get("after");let a=new Date(r).getTime();isNaN(a)&&(a=0);let o=new Date(i).getTime();isNaN(o)&&(o=0);const l=getIdFromDisplayElement(e);apiRegisterEvent(l,n.toString(),a,o).then(s=>s.text()).then(()=>{updateInfo({events:[{Timestamp:a,After:o,Event:n.toString(),ItemId:l,TimeZone:""}]}),e.parentElement?.hidePopover()}).catch(alert)}const observer=new IntersectionObserver(onIntersection,{root:document.getElementById("entry-output"),rootMargin:"0px",threshold:.1}),modeDisplayEntry={add(e,t=!0){t&&changeResultStatsWithItem(e),renderDisplayItem(e)},sub(e,t=!0){t&&changeResultStatsWithItem(e,-1),removeDisplayItem(e)},refresh(e){let t=findInfoEntryById(e);t&&refreshDisplayItem(t)},addList(e,t=!0){displayEntryIntersected.clear(),t&&changeResultStatsWithItemList(e,1);for(let n=0;n<e.length;n++)n>5?displayQueue.push(e[n]):renderDisplayItem(e[n])},subList(e,t=!0){t&&changeResultStatsWithItemList(e,-1);const n=e.map(r=>r.ItemId);displayQueue=displayQueue.filter(r=>!n.includes(r.ItemId));for(let r of e)removeDisplayItem(r)},putSelectedInCollection(){const e=globalsNewUi.selectedEntries,t=prompt("Id of collection");if(!t)return;let n=[];for(let r of e)n.push(setParent(r.ItemId,BigInt(t)));Promise.all(n).then(r=>{for(let i of r)console.log(i.status)})},addTagsToSelected(){const e=prompt("tags (, seperated)");if(!e)return;const t=e.split(",");for(let n of globalsNewUi.selectedEntries)addEntryTags(n.ItemId,t)}};function hookActionButtons(e,t){let n=e.querySelector('[data-action="Begin+Pause+Resume"]');n&&n.addEventListener("click",a=>{let o=findUserEntryById(t.ItemId);if(!o)return;let l="";const s=Intl.DateTimeFormat().resolvedOptions().timeZone;if(canBegin(o.Status)?l="begin":canResume(o.Status)?l="resume":canPause(o.Status)&&(l="pause"),!l){alert("Cannot begin, resume, or pause");return}confirm(`Are you sure you want to ${l} this entry`)&&fetch(`${apiPath}/engagement/${l?.toLowerCase()}-media?id=${o.ItemId}&timezone=${encodeURIComponent(s)}`).then(c=>c.text()).then(c=>{alert(c),loadUserEvents().then(()=>updateInfo({entries:{[String(t.ItemId)]:t}}))})});for(let a of e.querySelectorAll("[data-action]")||[]){let o=a.getAttribute("data-action");o?.includes("+")||a.addEventListener("click",l=>{if(!confirm(`Are you sure you want to ${o} this entry`))return;let s=`?id=${t.ItemId}`;if(o==="Finish"){let g=promptNumber("Rating",`Not a number
Rating`);g!==null&&(s+=`&rating=${g}`)}const c=Intl.DateTimeFormat().resolvedOptions().timeZone;fetch(`${apiPath}/engagement/${o?.toLowerCase()}-media${s}&timezone=${encodeURIComponent(c)}`).then(g=>g.text()).then(g=>{alert(g),loadUserEvents().then(()=>updateInfo({entries:{[String(t.ItemId)]:t}}))})})}let r=e.getElementById("thumbnail");const i=e.getElementById("thumbnail-file-upload");i.onchange=async function(a){const o=new FileReader,l=i.files?.[0];l&&(o.readAsDataURL(l),o.onload=()=>{if(!o.result)return;let s=o.result.toString();updateThumbnail(t.ItemId,s).then(()=>{let c=findMetadataById(t.ItemId);c?(c.Thumbnail=s,updateInfo({entries:{[String(t.ItemId)]:t},metadataEntries:{[String(t.ItemId)]:c}})):refreshInfo().then(()=>{refreshDisplayItem(t),refreshSidebarItem(t)})})})},r.onclick=function(a){i&&(i.click(),console.log(i.value))}}function updateCostDisplay(e,t){const n=e.getElementById("cost"),r=e.getElementById("include-self-in-cost").checked,i=e.getElementById("include-children-in-cost").checked,a=e.getElementById("include-copies-in-cost").checked;let o=0;if(r&&(o+=t.PurchasePrice),i){let l=Object.values(globalsNewUi.entries).filter(s=>s.ParentId===t.ItemId);for(let s of l)o+=s.PurchasePrice}if(a){let l=Object.values(globalsNewUi.entries).filter(s=>s.CopyOf===t.ItemId);for(let s of l)o+=s.PurchasePrice}n.innerText=String(o)}function createRelationButtons(e,t){let n=t.toArray(),r=n.map(i=>i.En_Title);n=n.sort((i,a)=>(sequenceNumberGrabber(i.En_Title,r)||0)-(sequenceNumberGrabber(a.En_Title,r)||0));for(let i of n){let a=findMetadataById(i.ItemId),o;a?.Thumbnail?(o=document.createElement("img"),formatToName(i.Format).then(l=>{o.title=`${i.En_Title} (${typeToSymbol(i.Type)} on ${l})`}),o.src=a.Thumbnail):(o=document.createElement("button"),o.innerText=i.En_Title),e.append(o),o.onclick=()=>toggleItem(i)}}function updateDisplayEntryContents(e,t,n,r,i){const a=i.getElementById("main-title"),o=i.getElementById("official-native-title"),l=i.getElementById("thumbnail"),s=i.getElementById("description"),c=i.getElementById("notes"),g=i.getElementById("user-rating"),p=i.getElementById("audience-rating"),T=i.getElementById("info-raw"),E=i.getElementById("meta-info-raw"),v=i.getElementById("view-count"),m=i.getElementById("entry-progressbar"),y=i.getElementById("entry-progressbar-position-label"),u=i.getElementById("media-info"),f=i.getElementById("user-actions"),w=i.getElementById("custom-styles");updateCostDisplay(i,e);let M=getUserExtra(t,"styles")||"";w.innerText=M;const b=i.getElementById("tags");b.innerHTML="";for(let d of e.Tags||[]){if(d=d.trim(),!d)continue;const I=document.createElement("div"),S=document.createElement("button");S.innerText="\u{1F5D1}",S.classList.add("delete"),S.onclick=function(){deleteEntryTags(e.ItemId,[d]).then(h=>{if(h.status!==200)return"";h.text().then(()=>{e.Tags=e.Tags.filter(U=>U!=d),changeDisplayItemData(e,t,n,r,i.host)})}).catch(console.error)},I.append(S);const L=document.createElement("span");L.classList.add("tag"),L.innerText=d,I.append(L),b?.append(I)}let $=typeToSymbol(e.Type);a?.setAttribute("data-type-icon",$),formatToName(e.Format).then(d=>{a?.setAttribute("data-format-name",d)}),a.innerText=n.Title||e.En_Title,n.Title&&e.En_Title&&(a.title=e.En_Title),o.innerText=n.Native_Title||e.Native_Title,n.Native_Title&&e.Native_Title&&(o.title=e.Native_Title),l.alt=n.Title||e.En_Title,l.src=n.Thumbnail,s.innerHTML=n.Description,c.innerHTML=t.Notes,t.UserRating?(applyUserRating(t.UserRating,g),g.innerHTML=String(t.UserRating)):g.innerText="Unrated";let B=n.RatingMax;if(n.Rating){let d=n.Rating,I=d;B!==0&&(I=d/B*100),applyUserRating(I,p),p.innerHTML=String(d)}else p&&(p.innerText="Unrated");mkGenericTbl(T,e);let k=n;mkGenericTbl(E,k);let C=t.ViewCount;if(C){let d;try{d=JSON.parse(k.MediaDependant)}catch{console.error("Could not parse media dependant meta info json");return}v.setAttribute("data-time-spent",String(Number(C)*Number(d["Show-length"]||d["Movie-length"]||0)/60||"unknown")),v.innerText=String(C)}let x=e.Type;x=String(x);let H;try{H=JSON.parse(n.MediaDependant)}catch{console.error("Could not parse json",n.MediaDependant);return}let A={};for(let d in H){const I=H[d];d=d.split("-").slice(1).join(" "),A[d]=I}if(mkGenericTbl(u,A),i.host.setAttribute("data-user-status",t.Status),H[`${x}-episodes`]&&t.Status==="Viewing"){m.max=H[`${x}-episodes`];let d=Number(t.CurrentPosition);m.value=d,y.innerText=`${d}/${m.max}`,y.title=`${Math.round(d/m.max*1e3)/10}%`}m.title=t.CurrentPosition,m.max&&(m.title=`${t.CurrentPosition}/${m.max}`);for(let d of[["descendants",findDescendants],["copies",findCopies]]){let I=i.getElementById(d[0]);I.innerHTML="",createRelationButtons(I,d[1](e.ItemId))}if(r.length){let d=`
            <thead>
                <tr>
                    <!-- this nonsense is so that the title lines up with the events -->
                    <th>
                        <div class="grid column">
                            <button popovertarget="new-event-form">\u2795\uFE0E</button><span style="text-align: center">Event</span>
                        </div>
                    </th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
        `;for(let I of r){const S=I.Timestamp,L=I.After,h=I.TimeZone||"UTC",U=I.Event;let _=new Date(I.Timestamp),F=new Date(I.After),R="";if(S!==0){let P=_.toLocaleTimeString("en",{timeZone:h}),D=_.toLocaleDateString("en",{timeZone:h});R=`<td title="${P} (${h})">${D}</td>`}else if(L!==0){let P=F.toLocaleTimeString("en",{timeZone:h}),D=F.toLocaleDateString("en",{timeZone:h});R=`<td title="${P} (${h})">after: ${D}</td>`}else R='<td title="unknown">unknown</td>';d+=`<tr>
                        <td>
                            <div class="grid column">
                                <button class="delete" onclick="deleteEvent(this, ${S}, ${L})">\u{1F5D1}</button>
                                ${U}
                            </div>
                        </td>
                            ${R}
                        </tr>`}d+="</tbody>",f.innerHTML=d}else f.innerHTML=""}function renderDisplayItem(e,t=displayItems){let n=document.createElement("display-entry");observer.observe(n);let r=findMetadataById(e.ItemId),i=findUserEntryById(e.ItemId),a=findUserEventsById(e.ItemId);if(!i||!r||!a)return;t.append(n);let o=n.shadowRoot;if(!o)return;const l=o.getElementById("include-self-in-cost"),s=o.getElementById("include-children-in-cost"),c=o.getElementById("include-copies-in-cost");for(let m of[l,c,s])m.onchange=function(){updateCostDisplay(o,e)};let g=getUserExtra(i,"styles"),p=o.getElementById("style-editor");p.value=g||"",p.addEventListener("change",m=>{const y=o.getElementById("custom-styles");y.innerText=p.value}),o.getElementById("new-child").addEventListener("click",m=>{const y=document.getElementById("new-entry"),u=y.querySelector('[name="parentId"]');u.value=String(e.ItemId),y.showPopover()});const E=o.getElementById("new-child-by-id");E.onchange=function(){let m=BigInt(E.value),y=findInfoEntryById(m);y&&(y.ParentId=e.ItemId,setParent(m,e.ItemId).then(()=>{updateInfo({entries:{[String(e.ItemId)]:e,[E.value]:y}})}))},hookActionButtons(o,e);const v=o.getElementById("create-tag");v.onclick=function(){const m=prompt("Tag name (, seperated)");if(!m)return;let y=m.split(",");e.Tags=e.Tags?.concat(y)||y,addEntryTags(e.ItemId,m.split(",")).then(u=>{if(u.status!==200)return"";u.text().then(()=>changeDisplayItemData(e,i,r,a,n))}).catch(console.error)},n.addEventListener("data-changed",function(m){const u=m,f=u.detail.item,w=u.detail.user,N=u.detail.meta,M=u.detail.events;updateDisplayEntryContents(f,w,N,M,n.shadowRoot)}),changeDisplayItemData(e,i,r,a,n);for(let m of o.querySelectorAll("[contenteditable]"))m.addEventListener("keydown",handleRichText)}function removeDisplayItem(e){displayEntryIntersected.delete(String(e.ItemId));const t=displayItems.querySelector(`[data-item-id="${e.ItemId}"]`);t&&(t.remove(),observer.unobserve(t))}function refreshDisplayItem(e){let t=document.querySelector(`display-entry[data-item-id="${e.ItemId}"]`);if(t){let n=findUserEntryById(e.ItemId),r=findUserEventsById(e.ItemId),i=findMetadataById(e.ItemId);if(!n||!r||!i)return;changeDisplayItemData(e,n,i,r,t)}else renderDisplayItem(e)}function getIdFromDisplayElement(e){let n=e.getRootNode().host;return n?BigInt(String(n.getAttribute("data-item-id"))):0n}function displayEntryAction(e){return function(t){let n=getIdFromDisplayElement(t),r;(r=findInfoEntryById(n))&&e(r,t.getRootNode())}}const displayEntryDelete=displayEntryAction(e=>deleteEntryUI(e)),displayEntryRefresh=displayEntryAction((e,t)=>overwriteEntryMetadataUI(t,e)),displayEntrySave=displayEntryAction((e,t)=>saveItemChanges(t,e)),displayEntryClose=displayEntryAction(e=>deselectItem(e)),displayEntryEditStyles=displayEntryAction((e,t)=>{const n=t.getElementById("style-editor");n.hidden=!n.hidden}),displayEntryCopyTo=displayEntryAction(e=>{let t=promptNumber("Copy user info to (item id)","Not a number, mmust be item id number",BigInt);if(t===null)return;let n=BigInt(t);copyUserInfo(e.ItemId,n).then(r=>r?.text()).then(console.log)}),displayEntryViewCount=displayEntryAction(e=>{let t=promptNumber("New view count","Not a number, view count");t!==null&&fetch(`${apiPath}/engagement/mod-entry?id=${e.ItemId}&view-count=${t}`).then(n=>n.text()).then(alert).then(()=>{let n=findUserEntryById(e.ItemId);n?(n.ViewCount=Number(t),updateInfo({entries:{[String(e.ItemId)]:e},userEntries:{[String(e.ItemId)]:n}})):refreshInfo().then(()=>{refreshDisplayItem(e)})}).catch(console.error)}),displayEntryProgress=displayEntryAction(async(e,t)=>{let n=t.getElementById("entry-progressbar"),r=promptNumber("Current position:","Not a number, current position");r&&(await setPos(e.ItemId,String(r)),t.host.setAttribute("data-user-current-position",String(r)),n.value=Number(r))}),displayEntryRating=displayEntryAction(e=>{let t=findUserEntryById(e.ItemId);if(!t){alert("Failed to get current rating");return}let n=prompt("New rating");!n||isNaN(Number(n))||(fetch(`${apiPath}/engagement/mod-entry?id=${e.ItemId}&rating=${n}`).then(()=>{let r=findUserEntryById(e.ItemId);if(!r)return refreshInfo();r.UserRating=Number(n),updateInfo({entries:{[String(e.ItemId)]:e},userEntries:{[String(e.ItemId)]:r}})}).catch(console.error),apiRegisterEvent(e.ItemId,`rating-change - ${t?.UserRating} -> ${n}`,Date.now(),0).catch(console.error))});function deleteEvent(e,t,n){if(!confirm("Are you sure you would like to delete this event"))return;const r=getIdFromDisplayElement(e);apiDeleteEvent(r,t,n).then(i=>i.text()).then(()=>loadUserEvents().then(()=>updateInfo({entries:{[String(r)]:globalsNewUi.entries[String(r)]}}))).catch(alert)}
