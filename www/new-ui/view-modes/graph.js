function getCtx2(e){return document.getElementById(e).getContext("2d")}const typeColors={Manga:"#e5c890",Show:"#f7c8e0",Movie:"#95bdff",MovieShort:"#b4e4ff",Song:"#dfffd8",Game:"#fed8b1",Book:"gainsboro",Collection:"#b4befe"},ctx=getCtx2("by-year"),rbyCtx=getCtx2("rating-by-year"),groupBySelect=document.getElementById("group-by"),typeSelection=document.getElementById("chart-type"),groupByInput=document.getElementById("group-by-expr");function ChartManager(e){let t=null;return async function(i){t&&t.destroy(),t=await e(i)}}function mkPieChart(e,t,i,r,s=[]){let o={type:"pie",data:{labels:t,datasets:[{label:r,data:i,borderWidth:1}]},options:{plugins:{legend:{labels:{color:"white"}},title:{color:"white",display:!0,text:r}},responsive:!0}};return s.length&&(o.data.datasets[0].backgroundColor=s),new Chart(e,o)}function mkBarChart(e,t,i,r){return new Chart(e,{type:"bar",data:{labels:t,datasets:[{label:r,data:i,borderWidth:1,backgroundColor:"#95bdff"}]},options:{plugins:{legend:{labels:{color:"white"}}},responsive:!0,scales:{y:{grid:{color:"grey"},ticks:{color:"white"},beginAtZero:!0},x:{grid:{color:"grey"},ticks:{color:"white"}}}}})}function mkXTypeChart(e,t,i,r){const s=typeSelection.value;if(s==="bar")return mkBarChart(e,t,i,r);{let o=s==="pie-percentage"?i.reduce((a,g)=>a+g,0):0,l={};for(let a=0;a<i.length;a++)l[t[a]]=s==="pie-percentage"?i[a]/o*100:i[a];const n=Object.entries(l).sort(([a,g],[c,y])=>y-g);return i=n.map(a=>a[1]),t=n.map(a=>a[0]),mkPieChart(e,t,i,r)}}function getWatchTime(e,t){if(!t.MediaDependant)return 0;let i;try{i=JSON.parse(t.MediaDependant)}catch{return console.error("Could not parse json",t.MediaDependant),0}let r=0;for(let s of["Show","Movie"])if(`${s}-length`in i){r=Number(i[`${s}-length`]);break}return isNaN(r)?0:r*e}function fillGap(e,t){e[t]=[],Number(t)+1 in e||fillGap(e,String(Number(t)+1))}function organizeDataByExpr(e){let t=groupByInput.value,i=Object.groupBy(e,r=>{let s=findMetadataById(r.ItemId),o=findUserEntryById(r.ItemId),l=makeSymbolsTableFromObj({...r,...s,...o});return parseExpression(t,l).toStr().jsValue});for(let r in i)i[r].length===0&&delete i[r];return i}async function organizeData(e){let t=groupBySelect.value;const i={Year:n=>globalsNewUi.metadataEntries[String(n.ItemId)].ReleaseYear,Decade:n=>{const a=String(globalsNewUi.metadataEntries[String(n.ItemId)].ReleaseYear);if(a=="0")return"0";let g=a.slice(0,2),c=a.slice(2)[0];return`${g}${c}0s`},Century:n=>{const a=String(globalsNewUi.metadataEntries[String(n.ItemId)].ReleaseYear);return a=="0"?"0":`${a.slice(0,2)}00s`},Type:n=>n.Type,Format:n=>formats[n.Format]||"N/A",Status:n=>globalsNewUi.userEntries[String(n.ItemId)].Status,"View-count":n=>globalsNewUi.userEntries[String(n.ItemId)].ViewCount,"Is-anime":n=>(n.ArtStyle&1)==1,"Item-name":n=>n.En_Title};let r;if(t==="Tags"){r={};for(let n of e)for(let a of n.Tags)r[a]?r[a].push(n):r[a]=[n]}else groupByInput.value?r=organizeDataByExpr(e):r=Object.groupBy(e,i[t]);let s=document.getElementsByName("sort-by")[0];if(s.value==""&&t==="Year"){let a=+Object.keys(r).sort((g,c)=>+c-+g)[0];for(let g in r){let c=+g;if(a===c)break;c<1975||c+1 in r||fillGap(r,String(c+1))}}let o=Object.keys(r),l=Object.values(r);if(s.value=="rating"){let n=Object.entries(r).sort((a,g)=>{let c=a[1].reduce((d,u)=>{let m=findUserEntryById(u.ItemId);return d+(m?.UserRating||0)},0);return g[1].reduce((d,u)=>{let m=findUserEntryById(u.ItemId);return d+(m?.UserRating||0)},0)/g[1].length-c/a[1].length});o=n.map(a=>a[0]),l=n.map(a=>a[1])}else if(s.value==="cost"){let n=Object.entries(r).sort((a,g)=>{let c=a[1].reduce((d,u)=>d+(u?.PurchasePrice||0),0);return g[1].reduce((d,u)=>d+(u?.PurchasePrice||0),0)-c});o=n.map(a=>a[0]),l=n.map(a=>a[1])}return[o,l]}function sortXY(e,t){let i={};for(let s=0;s<e.length;s++)i[e[s]]=t[s];let r=Object.entries(i).sort(([s,o],[l,n])=>n-o);return e=r.map(s=>s[0]),t=r.map(s=>s[1]),[e,t]}const watchTimeByYear=ChartManager(async e=>{let[t,i]=await organizeData(e),r=i.map(s=>s.map(o=>{let l=globalsNewUi.userEntries[String(o.ItemId)].ViewCount,n=globalsNewUi.metadataEntries[String(o.ItemId)];return getWatchTime(l,n)/60}).reduce((o,l)=>o+l,0));return mkXTypeChart(getCtx2("watch-time-by-year"),t,r,"Watch time")}),adjRatingByYear=ChartManager(async e=>{let[t,i]=await organizeData(e),r=i,s=0,o=0;for(let g of r)s+=g.length,o+=g.reduce((c,y)=>c+globalsNewUi.userEntries[String(y.ItemId)].UserRating,0);let l=s/r.length,n=o/s;const a=i.map(g=>g.map(u=>globalsNewUi.userEntries[String(u.ItemId)].UserRating).reduce((u,m)=>u+m,0)/g.length-n+(g.length-l));return mkXTypeChart(getCtx2("adj-rating-by-year"),t,a,"adj ratings")}),costByFormat=ChartManager(async e=>{e=e.filter(s=>s.PurchasePrice>0);let[t,i]=await organizeData(e),r=i.map(s=>s.reduce((o,l)=>o+l.PurchasePrice,0));return mkXTypeChart(getCtx2("cost-by-format"),t,r,"Cost by")}),ratingByYear=ChartManager(async e=>{let[t,i]=await organizeData(e);const r=i.map(s=>s.map(o=>globalsNewUi.userEntries[String(o.ItemId)].UserRating).reduce((o,l,n)=>(o*n+l)/(n+1),0));return mkXTypeChart(rbyCtx,t,r,"ratings")}),generalRating=ChartManager(async e=>{let[t,i]=await organizeData(e);const r=i.map(s=>s.map(o=>{let l=findMetadataById(o.ItemId),n=l?.Rating,a=l?.RatingMax;return n&&a?n/a*100:0}).reduce((o,l,n)=>(o*n+l)/(n+1),0));return mkXTypeChart(getCtx2("general-rating-by-year"),t,r,"general ratings")}),ratingDisparityGraph=ChartManager(async e=>{let[t,i]=await organizeData(e);const r=i.map(s=>s.map(o=>{let l=findMetadataById(o.ItemId),n=findUserEntryById(o.ItemId),a=l?.Rating,g=l?.RatingMax;if(a&&g){let c=a/g*100;return(n?.UserRating||0)-c}return n?.UserRating||0}).reduce((o,l)=>o+l,0));return mkXTypeChart(getCtx2("rating-disparity-graph"),t,r,"Rating disparity")}),byc=ChartManager(async e=>{let[t,i]=await organizeData(e);const r=i.map(s=>s.length);return mkXTypeChart(ctx,t,r,"#items")});function makeGraphs(e){byc(e),ratingByYear(e),adjRatingByYear(e),costByFormat(e),watchTimeByYear(e),generalRating(e),ratingDisparityGraph(e)}groupByInput.onchange=function(){makeGraphs(globalsNewUi.selectedEntries)},groupBySelect.onchange=typeSelection.onchange=function(){makeGraphs(globalsNewUi.selectedEntries)};const modeGraphView={add(e,t=!0){t&&changeResultStatsWithItem(e),makeGraphs(globalsNewUi.selectedEntries)},sub(e,t=!0){t&&changeResultStatsWithItem(e,-1),makeGraphs(globalsNewUi.selectedEntries)},addList(e,t=!0){t&&changeResultStatsWithItemList(e),makeGraphs(globalsNewUi.selectedEntries)},subList(e,t=!0){t&&changeResultStatsWithItemList(e,-1)}};
