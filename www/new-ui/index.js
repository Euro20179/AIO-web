let globalsNewUi={userEntries:{},metadataEntries:{},entries:{},results:[],events:[],selectedEntries:[],libraries:{},viewingLibrary:0n};const displayItems=document.getElementById("entry-output"),statsOutput=document.getElementById("result-stats"),librarySelector=document.getElementById("library-selector"),newEntryLibrarySelector=document.querySelector('[name="libraryId"]');librarySelector.onchange=function(){let e=librarySelector.value;globalsNewUi.viewingLibrary=BigInt(e),loadSearch()};function getUserExtra(e,t){return JSON.parse(e.Extra).AIOWeb?.[t]||null}function setUserExtra(e,t,r){let i=JSON.parse(e.Extra),s=i.AIOWeb||{};s[t]=r,i.AIOWeb=s,e.Extra=JSON.stringify(i)}function*findDescendants(e){yield*Object.values(globalsNewUi.entries).values().filter(r=>r.ParentId===e)}function*findCopies(e){yield*Object.values(globalsNewUi.entries).values().filter(r=>r.CopyOf===e)}function resetResultStats(){for(let e of statsOutput.querySelectorAll(".stat")||[])e.setAttribute("data-value","0");return{totalCost:0,count:0}}let resultStatsProxy=new Proxy({count:0,totalCost:0,results:0,reset(){this.count=0,this.totalCost=0}},{set(e,t,r){return Reflect.set(...arguments)?(statsOutput.querySelector(`[data-stat-name="${String(t)}"]`).setAttribute("data-value",String(r)),!0):!1}});function setResultStat(e,t){resultStatsProxy[e]=t}function changeResultStats(e,t){resultStatsProxy[e]+=t}function changeResultStatsWithItem(e,t=1){changeResultStats("totalCost",e.PurchasePrice*t),changeResultStats("count",1*t)}function changeResultStatsWithItemList(e,t=1){for(let r of e)changeResultStatsWithItem(r,t)}function updateLibraryDropdown(){for(let e in globalsNewUi.libraries){let t=globalsNewUi.libraries[e];const r=document.createElement("option");r.value=String(t.ItemId),r.innerText=t.En_Title,librarySelector.append(r)}newEntryLibrarySelector.innerHTML=librarySelector.innerHTML}async function loadLibraries(){const e=await doQuery3("type = 'Library'");librarySelector.innerHTML='<option value="0">Library</option>';for(let t of e)globalsNewUi.libraries[String(t.ItemId)]=t;updateLibraryDropdown()}async function loadInfoEntries(){const e=await fetch(`${apiPath}/list-entries?uid=${uid}`).catch(console.error);if(!e){alert("Could not load all entries");return}let r=(await e.text()).split(`
`).filter(Boolean),i={};for(let s of r.map(mkStrItemId).map(parseJsonL))i[s.ItemId]=s;return setResultStat("results",r.length),globalsNewUi.entries=i}function findMetadataById(e){return globalsNewUi.metadataEntries[String(e)]}function findUserEntryById(e){return globalsNewUi.userEntries[String(e)]}function findUserEventsById(e){return globalsNewUi.events.filter(t=>t.ItemId===e)}function findInfoEntryById(e){return globalsNewUi.entries[String(e)]}async function loadUserEntries(){let e=await loadList("engagement/list-entries"),t={};for(let r of e)t[String(r.ItemId)]=r;return globalsNewUi.userEntries=t}async function loadUserEvents(){return globalsNewUi.events=await loadList("engagement/list-events")}async function loadMetadata(){let e=await loadList("metadata/list-entries"),t={};for(let r of e)t[String(r.ItemId)]=r;return globalsNewUi.metadataEntries=t}function parseClientsideSearchFiltering(e){let t=e.get("search-query"),r;[t,...r]=t.split("->"),r=r.map(s=>s.trim());let i=e.get("sort-by");return{filterRules:r,newSearch:t,sortBy:i}}function applyClientsideSearchFiltering(entries,filters){entries=entries.filter(e=>e.Library===globalsNewUi.viewingLibrary),filters.sortBy!==""&&(entries=sortEntries(entries,filters.sortBy));for(let filter of filters.filterRules){if(filter=filter.trim(),filter.startsWith("is")){let e=filter.split("is")[1]?.trim();if(!e)continue;e=e.replace(/(\w)(\S*)/g,(t,r,i)=>r.toUpperCase()+i),entries=entries.filter(t=>t.Type==e)}let slicematch=filter.match(/\[(\d*):(-?\d*)\]/);if(slicematch){let e=+slicematch[1],t=+slicematch[2];entries=entries.slice(e,t)}if(filter.startsWith("/")&&filter.endsWith("/")){let e=new RegExp(filter.slice(1,filter.length-1));entries=entries.filter(t=>t.En_Title.match(e))}else if(filter=="shuffle"||filter=="shuf")entries=entries.sort(()=>Math.random()-Math.random());else if(filter.startsWith("head")){const e=filter.slice(4).trim()||1;entries=entries.slice(0,Number(e))}else if(filter.startsWith("tail")){const e=filter.slice(4).trim()||1;entries=entries.slice(entries.length-Number(e))}else if(filter.startsWith("sort")){let type=filter.slice(4).trim()||"a";const reversed=type.startsWith("-")?-1:1;switch(reversed==-1&&(type=type.slice(1)),type[0]){case"a":entries.sort((e,t)=>(e.En_Title>t.En_Title?1:-1)*reversed);break;case"e":{const fn=type.slice(1);entries.sort(()=>eval(fn));break}}}else if(filter.startsWith("filter")){let expr=filter.slice(6).trim();entries=entries.filter(()=>eval(expr))}else filter==="!child"?entries=entries.filter(e=>e.ParentId===0n):filter==="!copy"&&(entries=entries.filter(e=>e.CopyOf===0n))}return entries}async function loadSearch(){let e=document.getElementById("sidebar-form"),t=new FormData(e),r=parseClientsideSearchFiltering(t),i=await doQuery3(String(r.newSearch)||"#");if(i=applyClientsideSearchFiltering(i,r),setResultStat("results",i.length),globalsNewUi.results=i,clearItems(),i.length===0){setError("No results"),clearSidebar();return}renderSidebar(i)}function normalizeRating(e,t){return e/t*100}function genericMetadata(e){return{ItemId:e,Rating:0,RatingMax:0,Description:"",ReleaseYear:0,Thumbnail:"",MediaDependant:"",Datapoints:"{}",Title:"",Native_Title:""}}function genericUserEntry(e){return{ItemId:e,Status:"",ViewCount:0,UserRating:0,Notes:"",CurrentPosition:"",Extra:"{}"}}function updateInfo({entries:e,metadataEntries:t,events:r,userEntries:i},s=!1){if(s&&r){let l=r.map(n=>`${n.ItemId}:${n.Timestamp||n.After}:${n.Event}`);globalsNewUi.events=globalsNewUi.events.filter(n=>!l.includes(`${n.ItemId}:${n.Timestamp||n.After}:${n.Event}`))}else r&&(globalsNewUi.events=globalsNewUi.events.concat(r));let a=!1;for(let l in e){let n=e[l];if(n.Type==="Library"&&(s?delete globalsNewUi.libraries[l]:globalsNewUi.libraries[l]=n,a=!0),s)delete globalsNewUi.entries[l],delete globalsNewUi.metadataEntries[l],delete globalsNewUi.userEntries[l];else{let o=t?.[l]||findMetadataById(n.ItemId)||genericMetadata(n.ItemId),u=i?.[l]||findUserEntryById(n.ItemId)||genericUserEntry(n.ItemId);globalsNewUi.entries[l]=n,globalsNewUi.metadataEntries[l]=o,globalsNewUi.userEntries[l]=u,refreshSidebarItem(n),mode.refresh&&mode.refresh(n.ItemId)}}a&&updateLibraryDropdown()}async function refreshInfo(){return Promise.all([loadLibraries(),loadInfoEntries(),loadMetadata(),loadUserEntries(),loadUserEvents()])}async function main(){if(await refreshInfo(),initialSearch){let e=await doQuery3(initialSearch);if(setResultStat("results",e.length),globalsNewUi.results=e,e.length===0){alert("No results");return}renderSidebar(e)}else{let e=Object.values(globalsNewUi.entries).sort((t,r)=>{let i=findUserEntryById(t.ItemId),s=findUserEntryById(r.ItemId);return!i||!s?0:s?.UserRating-i?.UserRating});globalsNewUi.results=e,renderSidebar(e)}}main();let servicing=!1;async function remote2LocalThumbService(){if(!servicing){servicing=!0;for(let e in globalsNewUi.metadataEntries){let t=globalsNewUi.metadataEntries[e],r=t.Thumbnail,i=globalsNewUi.entries[e].En_Title,s=globalsNewUi.entries[e].Native_Title;if(r&&!(r.startsWith(`${apiPath}/resource/thumbnail`)||r.startsWith(`${apiPath}/resource/get-thumbnail`))&&(console.log(r),!r.startsWith("data:")&&(console.log(`${i||s||t.Title||t.Native_Title} Has a remote image url, downloading`),fetch(`${apiPath}/resource/download-thumbnail?id=${t.ItemId}`).then(a=>a.status!==200?"":a.text()).then(a=>{a&&(console.log(`THUMBNAIL HASH: ${a}`),updateThumbnail(t.ItemId,`${apiPath}/resource/get-thumbnail?hash=${a}`).then(l=>l.text()).then(console.log))}),await new Promise(a=>setTimeout(a,200)),!servicing)))break}console.log("ALL IMAGES HAVE BEEN INLINED"),servicing=!1}}
